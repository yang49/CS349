import java.sql.*;
import java.util.*;
import java.lang.String;
import java.lang.Integer;

class Main{
	static final String JDBC_DRIVER = "com.ibm.db2.jcc.DB2Driver";
	static final String DB_URL = "jdbc:db2://linux.student.cs.uwaterloo.ca:50002/cs348";
	
	static final String USR = "db2guest";
	static final String PSW = "upKellynoisylair";
	
	//Main function
	public static void main(String[] args) {
		System.out.println("CS348");
		Connection conn = null;
		Statement stmt = null;
		ResultSet rs = null;
		//try
		try {
			//STEP 2: Register the JDBC driver
			Class.forName(JDBC_DRIVER);
		
			//STEP 3: Open a connection
			System.out.println("Connecting to database");
			conn = DriverManager.getConnection(DB_URL, USR, PSW);
			Statement s = conn.createStatement();
			s.executeUpdate("SET SCHEMA enrollment");
			//s.executeUpdate("SET sql_mode 'ONLY_FULL_GROUP_BY'");
			s.close();
			System.out.println("Connected");
			Scanner sc = new Scanner(System.in);
			
			//While loop
			while(true) {
				////////////////////////////////////////////////////
				//Get the usr input
				System.out.println("Please enter the DEPARTMENT NAME: ");
				String Dept = sc.next();
				if (Dept.equals("exit")) break;
				System.out.println("The DEPARTMENT NAME -> " + Dept);
				
				System.out.println("Please enter the BEGINNING YEAR: ");
				String begin = sc.next();
				if (begin.equals("exit")) break;
				System.out.println("The BEGINNING YEAR -> " + begin.substring(2,4));
				String yr_begin = "F" + begin.substring(2,4);
				
				System.out.println("Please enter the ENDDING YEAR: ");
				String end = sc.next();
				if (end.equals("exit")) break;
				String yr_end = "S" + end.substring(2,4);
				
				////////////////////////////////////////////////////
				
				//STEP 4: Excecute a query
				stmt = conn.createStatement();
				String sql;
				//sql = "select * from professor";
				/*sql = "SELECT	cno, term,section , AVG(mark) AS avg_mark2 " + 
						 "			 			 FROM			enrollment " + 
						 "			 			 WHERE term < 'W12' " + 
						 "GROUP BY cno, term, section";*/
				/*sql = "SELECT tt.cno, tt.term, COUNT(*) AS num_s " + 
						 "			 FROM	  	 (SELECT		cno, term, section, AVG(mark) AS avg_mark1 " +
						 "					  	  FROM			enrollment " + 
						 "						  WHERE term < 'W12' " + 
						 "						  GROUP BY		cno, term, section) tt " + 
						 "			 GROUP BY tt.term, tt.cno"; */
				
				sql = "SELECT	t3.cno, c.cname, COUNT(e2.sno), num_s, min(t3.avg_mark1), max(t3.avg_mark1), t3.avg_mark2 " +
						"FROM		(SELECT 	t1.cno, t1.term, t1.section, t1.avg_mark1, t2.avg_mark2, num_s " +
						"			 FROM		(SELECT 	temp.cno, temp.term, temp.section,  avg_mark1 " +
						"			 			 FROM		(SELECT			cno, term, section, AVG(mark) AS avg_mark1 " + 
						 "			 			 			 FROM				enrollment " +
						 "		    			 			 WHERE     	 	term < 'W12' " + 
						 "		    			 			 GROUP BY		cno, term, section) temp, " +
						 "        						 class c, professor p " + 
						 "						 WHERE  	temp.cno = c.cno AND temp.term = c.term AND temp.section = c.section " + 
						 "									AND c.instructor = p.eid AND p.dept = 'CS' " + 
						 "						ORDER BY temp.term) t1, " + 
						 
						 "						(SELECT		cno, term, AVG(mark) AS avg_mark2 " + 
						 "			 			 FROM			enrollment " + 
						 "			 			 WHERE term < 'W12' " + 
						 "			 			 GROUP BY		cno, term) t2, " + 
						 
						 "					   (SELECT tt.cno, tt.term, COUNT(*) AS num_s " + 
						 "			 			 FROM	  	 (SELECT		cno, term, section, AVG(mark) AS avg_mark1 " +
						 "					  	  			  FROM			enrollment " + 
						 "						  			  WHERE term < 'W12' " + 
						 "						  			  GROUP BY		cno, term, section) tt " + 
						 "			 			 GROUP BY tt.term, tt.cno) tt1 " + 
						 
						 "			WHERE	 t1.cno = t2.cno AND t1.term = t2.term AND tt1.term = t1.term AND tt1.cno = t1.cno) t3, " + 
						 "			course c, enrollment e2 " + 
						"WHERE   	c.cno = t3.cno AND e2.term = t3.term AND e2.cno = t3.cno " +
						"GROUP BY t3.cno " ;
					
				rs = stmt.executeQuery(sql);
				while(rs.next()) {
					String cno = rs.getString("cno");
					String term = rs.getString("term");
					String avg_mark = rs.getString("num_s");
				//	String section = rs.getString("section");
				//	String instructor = rs.getString("instructor");
					
					System.out.println(cno + " " + term  + " " + avg_mark + " ");
				}
			}
				rs.close();
				stmt.close();
		}catch(SQLException se) {
			se.printStackTrace();
		}catch(Exception e) {
			e.printStackTrace();
		}// end try
	}//end main function
	
} //end with Main class
